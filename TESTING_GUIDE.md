# 文件保存功能测试指南

## 功能概述

现在系统支持在 **Electron 环境**和**浏览器环境**中静默保存生成的文件：

- **Electron 环境**：文件保存到文件系统的指定文件夹（静默保存，不弹出对话框）
- **浏览器环境**：文件保存到 IndexedDB（静默保存，不弹出对话框）

## 测试步骤

### 1. 启动应用

#### Electron 环境（推荐）
```bash
npm run electron:dev
```

#### 浏览器环境
```bash
npm run dev
```
然后在浏览器中打开 `http://localhost:5173`

### 2. 配置保存设置

1. 打开设置（点击设置按钮或使用快捷键）
2. 找到"默认保存"部分
3. 启用"启用默认保存"开关
4. 设置保存路径：
   - **相对路径**：例如 `outputs`（相对于应用目录）
   - **绝对路径**：例如 `D:\outputs`（Windows）或 `/Users/username/outputs`（Mac/Linux）
5. 如果使用相对路径，确保"使用相对路径"开关已启用

### 3. 创建测试工作流

1. 在画布上添加以下节点：
   - **图像输入节点** 或 **图像生成节点**
   - **图像预览节点**

2. 连接节点：
   - 将图像输入/生成的输出连接到图像预览节点的输入

3. 如果使用图像生成节点，需要配置 API 设置（在设置中）

### 4. 运行工作流

1. 点击右上角的"运行"按钮
2. 等待工作流执行完成
3. **验证**：文件应该被静默保存，不会弹出任何对话框

### 5. 验证保存结果

#### Electron 环境
检查文件系统：
- 打开设置的保存路径（或默认的 `outputs` 文件夹）
- 应该看到以下子文件夹：
  - `image/` - 图片文件
  - `video/` - 视频文件
  - `3Dmodels/` - 3D 模型文件
- 文件命名格式：`mxinspire[时间戳].png`（或其他扩展名）

#### 浏览器环境
1. 打开浏览器开发者工具（F12）
2. 进入 **Application** 标签页（Chrome）或 **Storage** 标签页（Firefox）
3. 展开 **IndexedDB** → `mxinspire-files`
4. 查看 `generated-files` 存储，应该能看到保存的文件数据

### 6. 验证历史记录

1. 打开左侧边栏的"历史"标签
2. 应该能看到刚才生成的文件
3. 点击文件可以预览（浏览器环境会从 IndexedDB 加载）

## 测试场景

### 场景 1：多次运行
1. 设置运行次数为 3
2. 运行工作流
3. **验证**：应该生成 3 个文件，每个都有唯一的时间戳

### 场景 2：不同文件类型
1. 创建包含图片、视频、3D 模型的预览节点
2. 运行工作流
3. **验证**：文件应该保存到对应的子文件夹（image、video、3Dmodels）

### 场景 3：路径配置
1. 测试相对路径：`outputs`
2. 测试绝对路径：`D:\MyOutputs`（Windows）或 `/Users/username/MyOutputs`（Mac/Linux）
3. **验证**：文件应该保存到指定路径

### 场景 4：浏览器环境
1. 在浏览器中运行应用（不是 Electron）
2. 启用保存功能
3. 运行工作流
4. **验证**：
   - 不弹出下载对话框
   - 文件保存到 IndexedDB
   - 历史记录可以正常显示和预览

## 故障排除

### 问题：文件没有保存
- 检查保存功能是否已启用
- 检查控制台是否有错误信息
- 检查文件路径是否正确

### 问题：Electron 环境中弹出对话框
- 确保使用的是 Electron 应用（`npm run electron:dev`），而不是浏览器
- 检查 `electronAPI` 是否正确暴露

### 问题：浏览器环境中弹出下载对话框
- 检查代码是否正确检测到浏览器环境
- 检查 IndexedDB 是否可用（某些浏览器可能不支持）

### 问题：历史记录不显示
- 检查保存功能是否已启用
- 刷新页面重新加载历史记录
- 检查控制台是否有错误信息

## 技术细节

### Electron 环境
- 使用 IPC 通信保存文件到文件系统
- 自动创建 `image`、`video`、`3Dmodels` 子文件夹
- 支持相对路径和绝对路径

### 浏览器环境
- 使用 IndexedDB 存储文件数据
- 文件以 Blob 形式存储
- 历史记录使用 Blob URL 显示

### 文件命名
- 格式：`mxinspire[时间戳].[扩展名]`
- 例如：`mxinspire1706425234567.png`
